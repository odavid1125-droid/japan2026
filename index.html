<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 東北凍動之旅</title>
    
    <!-- Libraries -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@500;700&display=swap" rel="stylesheet">

    <!-- Styles -->
    <style>
        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            background-color: #F3F8FC;
            color: #334155;
            -webkit-tap-highlight-color: transparent;
        }

        /* Japanese Font Class */
        .font-jp {
            font-family: 'Noto Sans JP', sans-serif;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 0px; background: transparent; }

        /* Transitions */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }

        .slide-up-enter-active, .slide-up-leave-active { transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .slide-up-enter-from { transform: translateY(100%); }
        .slide-up-leave-to { transform: translateY(100%); }

        /* Glassmorphism */
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-top: 1px solid rgba(255, 255, 255, 0.5);
        }

        .safe-bottom { padding-bottom: env(safe-area-inset-bottom, 20px); }
        .safe-top { padding-top: env(safe-area-inset-top, 20px); }
        
        /* Justify text */
        .text-justify-custom {
            text-align: justify;
            text-justify: inter-ideograph;
        }

        /* Checkbox Style */
        .checkbox-wrapper input:checked + div {
            background-color: #0ea5e9;
            border-color: #0ea5e9;
            color: white;
        }
    </style>
</head>
<body>

<div id="app" class="h-screen flex flex-col overflow-hidden relative bg-[#F3F8FC]">
    
    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-md z-20 px-4 py-3 shadow-sm flex items-center justify-between shrink-0 safe-top">
        <h1 class="text-xl font-bold text-sky-800 tracking-wider flex items-center">
            <i class="fa-regular fa-snowflake mr-2 text-sky-400 animate-spin-slow"></i>東北凍動之旅
        </h1>
        <div class="text-xs font-bold text-white bg-sky-400 px-3 py-1 rounded-full shadow-sm">
            <span v-if="currentTab === 'plan'">Day {{ activeDay }}</span>
            <span v-else>{{ getTabName(currentTab) }}</span>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-1 overflow-y-auto p-4 pb-28 relative scroll-smooth">
        
        <!-- HOME TAB (New Dashboard) -->
        <transition name="fade">
            <div v-if="currentTab === 'home'" key="home" class="space-y-5">
                
                <!-- 1. Weather Widget (Linked to Active Day Location) -->
                <div class="bg-gradient-to-br from-blue-500 to-sky-400 rounded-3xl p-5 text-white shadow-lg relative overflow-hidden">
                    <div class="absolute -right-6 -top-6 bg-white/20 w-32 h-32 rounded-full blur-2xl"></div>
                    
                    <div class="flex justify-between items-start relative z-10">
                        <div>
                            <div class="text-xs font-bold bg-white/20 inline-block px-2 py-1 rounded-lg mb-2">
                                <i class="fa-solid fa-location-dot mr-1"></i>{{ itinerary[activeDay].location.split(/->|→/)[0].trim() }} (Day {{ activeDay }})
                            </div>
                            <div class="text-4xl font-bold mb-1">{{ getWeather(activeDay).temp }}°C</div>
                            <div class="text-sm font-medium opacity-90">{{ getWeather(activeDay).desc }}</div>
                        </div>
                        <div class="text-5xl opacity-90">
                            <i :class="getWeather(activeDay).icon"></i>
                        </div>
                    </div>
                    <div class="mt-3 text-[10px] opacity-70 border-t border-white/20 pt-2">
                        ※ 顯示為該地區1月份歷史平均氣候
                    </div>
                </div>

                <!-- 2. Simple Calculator (Keypad Removed) -->
                <div class="bg-white rounded-3xl p-5 shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="font-bold text-slate-700"><i class="fa-solid fa-calculator mr-2 text-sky-500"></i>匯率換算</h2>
                        <span class="text-xs font-bold text-slate-400 bg-slate-100 px-2 py-1 rounded">匯率: {{ exchangeRate }}</span>
                    </div>
                    <div class="flex gap-3 items-center">
                        <div class="flex-1">
                            <label class="block text-xs text-slate-400 font-bold mb-1 ml-1">JPY 日幣</label>
                            <input type="number" v-model="calcJpy" @input="updateTwd" class="w-full bg-slate-50 rounded-xl px-4 py-3 font-bold text-slate-700 focus:ring-2 focus:ring-sky-200 outline-none text-lg" placeholder="0">
                        </div>
                        <div class="text-slate-300 pt-5"><i class="fa-solid fa-arrow-right-arrow-left"></i></div>
                        <div class="flex-1">
                            <label class="block text-xs text-slate-400 font-bold mb-1 ml-1">TWD 台幣</label>
                            <input type="number" v-model="calcTwd" @input="updateJpy" class="w-full bg-slate-50 rounded-xl px-4 py-3 font-bold text-slate-700 focus:ring-2 focus:ring-sky-200 outline-none text-lg" placeholder="0">
                        </div>
                    </div>
                </div>

                <!-- 3. Action Buttons (Checklist & Survival Japanese) -->
                <div class="grid grid-cols-2 gap-4">
                    <!-- Checklist Button -->
                    <button @click="showChecklistModal = true" class="bg-emerald-500 text-white p-5 rounded-3xl shadow-md flex flex-col items-center justify-center gap-2 active:scale-95 transition-transform relative overflow-hidden group">
                        <i class="fa-solid fa-clipboard-check text-4xl mb-1"></i>
                        <span class="font-bold text-lg">行前確認</span>
                        <div class="absolute -right-4 -bottom-4 bg-white/20 w-20 h-20 rounded-full blur-xl group-hover:scale-150 transition-transform"></div>
                    </button>

                    <!-- Survival Japanese Button -->
                    <button @click="japaneseLevel = 1" class="bg-amber-500 text-white p-5 rounded-3xl shadow-md flex flex-col items-center justify-center gap-2 active:scale-95 transition-transform relative overflow-hidden group">
                        <i class="fa-solid fa-comment-dots text-4xl mb-1"></i>
                        <span class="font-bold text-lg">求生日文</span>
                        <div class="absolute -right-4 -bottom-4 bg-white/20 w-20 h-20 rounded-full blur-xl group-hover:scale-150 transition-transform"></div>
                    </button>
                </div>

            </div>
        </transition>

        <!-- PLAN TAB -->
        <transition name="fade">
            <div v-if="currentTab === 'plan'" key="plan" class="space-y-5">
                <!-- Date Scroller -->
                <div class="flex overflow-x-auto gap-3 pb-2 -mx-4 px-4 scrollbar-hide snap-x">
                    <button 
                        v-for="(day, index) in itinerary" 
                        :key="index"
                        @click="activeDay = index"
                        :class="['flex-shrink-0 snap-center px-4 py-3 rounded-2xl flex flex-col items-center min-w-[4.5rem] transition-all duration-300', 
                                activeDay === index ? 'bg-sky-500 text-white shadow-lg scale-105' : 'bg-white text-slate-400 shadow-sm']"
                    >
                        <span class="text-xs opacity-80">{{ day.shortDate }}</span>
                        <span class="text-lg font-bold">{{ day.weekday }}</span>
                    </button>
                </div>

                <!-- Daily Header -->
                <div class="bg-white rounded-3xl p-5 shadow-sm border border-slate-100 relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-24 h-24 bg-sky-100 rounded-bl-full opacity-50 -mr-4 -mt-4"></div>
                    <h2 class="text-2xl font-bold text-slate-800 relative z-10">{{ itinerary[activeDay].title }}</h2>
                    <div class="flex items-center text-sky-600 text-sm mt-1 relative z-10 font-medium">
                        <i class="fa-solid fa-location-dot mr-1"></i>{{ itinerary[activeDay].location }}
                    </div>
                    <div class="mt-3 inline-flex items-center bg-indigo-50 text-indigo-700 px-3 py-1 rounded-lg text-xs font-bold">
                        <i class="fa-solid fa-bed mr-2"></i> {{ itinerary[activeDay].stay }}
                    </div>
                </div>

                <!-- Timeline -->
                <div class="relative pl-4 border-l-2 border-sky-100 space-y-6 pb-4">
                    <div v-for="(item, i) in itinerary[activeDay].schedule" :key="i" class="relative pl-6 group">
                        <!-- Dot -->
                        <div :class="['absolute -left-[9px] top-1.5 w-4 h-4 rounded-full border-2 border-white shadow-md z-10 transition-colors', 
                            item.highlight ? 'bg-rose-400 ring-4 ring-rose-100' : 'bg-sky-400 group-hover:bg-sky-500']"></div>
                        
                        <!-- Card -->
                        <div @click="!item.noDetail && openDetail(item)" 
                             :class="['bg-white p-4 rounded-2xl shadow-sm border border-slate-100 transition-all relative overflow-hidden', 
                                      !item.noDetail ? 'active:scale-95 cursor-pointer hover:shadow-md' : 'cursor-default']">
                            
                            <div v-if="!item.noDetail && (item.subItems || item.desc)" class="absolute top-3 right-3 text-slate-200">
                                <i class="fa-solid fa-chevron-right text-xs"></i>
                            </div>

                            <div class="flex items-baseline gap-2 mb-1">
                                <span class="text-sm font-bold text-sky-500 font-mono">{{ item.time }}</span>
                                <div v-if="item.highlight" class="text-[10px] bg-rose-100 text-rose-600 px-1.5 py-0.5 rounded font-bold">重要</div>
                            </div>
                            
                            <h3 class="font-bold text-slate-700 text-lg leading-tight mb-2">{{ item.activity }}</h3>
                            
                            <p class="text-sm text-slate-500 line-clamp-2 leading-relaxed whitespace-pre-line">{{ item.cardDesc || item.desc }}</p>

                            <div v-if="item.tags" class="flex flex-wrap gap-1.5 mt-3">
                                <span v-for="tag in item.tags" class="text-[10px] px-2 py-1 rounded-md bg-slate-100 text-slate-500 font-medium">
                                    #{{ tag }}
                                </span>
                            </div>

                            <div v-if="item.subItems" class="mt-3 flex -space-x-2 overflow-hidden py-1">
                                <div v-for="(sub, idx) in item.subItems.slice(0,4)" :key="idx" 
                                     class="inline-block h-6 w-6 rounded-full ring-2 ring-white bg-sky-100 flex items-center justify-center text-[10px] text-sky-600 font-bold">
                                     {{ idx + 1 }}
                                </div>
                                <div v-if="item.subItems.length > 4" class="inline-block h-6 w-6 rounded-full ring-2 ring-white bg-slate-100 flex items-center justify-center text-[10px] text-slate-400">
                                    +
                                </div>
                                <span class="ml-4 text-xs text-sky-500 font-bold self-center">查看 {{ item.subItems.length }} 個選項</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </transition>

        <!-- WALLET TAB -->
        <transition name="fade">
            <div v-if="currentTab === 'wallet'" key="wallet" class="space-y-6">
                
                <!-- Analysis Button -->
                <button @click="showAnalysis = true" class="w-full bg-indigo-600 text-white py-3 rounded-2xl font-bold shadow-lg active:scale-95 transition-transform flex items-center justify-center">
                    <i class="fa-solid fa-chart-pie mr-2"></i> 消費分析
                </button>

                <!-- New Expense Input Form -->
                <div class="bg-white rounded-3xl p-5 shadow-sm space-y-4">
                    <h3 class="font-bold text-slate-700 flex items-center"><i class="fa-solid fa-pen-to-square mr-2 text-sky-500"></i>新增記帳</h3>
                    
                    <!-- Date Select -->
                    <select v-model="newExpense.dateStr" class="w-full bg-slate-50 rounded-xl px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-sky-200 appearance-none text-slate-700 font-bold">
                        <option value="" disabled>選擇日期</option>
                        <option v-for="d in dateOptions" :value="d.value">{{ d.label }}</option>
                    </select>

                    <!-- Categories -->
                    <div class="flex flex-wrap gap-2">
                        <button v-for="cat in categories" :key="cat.id"
                            @click="newExpense.category = cat.id"
                            :class="['flex-1 min-w-[3rem] py-2 rounded-xl text-xs font-bold transition-colors', 
                                newExpense.category === cat.id ? 'bg-sky-500 text-white shadow-md' : 'bg-slate-100 text-slate-500 hover:bg-slate-200']">
                            <i :class="cat.icon" class="mb-1 block text-sm"></i>
                            {{ cat.name }}
                        </button>
                    </div>

                    <!-- Input Fields -->
                    <div class="flex gap-2">
                        <input v-model="newExpense.item" placeholder="消費品項" class="flex-[2] bg-slate-50 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-sky-200 outline-none">
                        <input type="number" v-model="newExpense.price" placeholder="¥ 金額" class="flex-[1] bg-slate-50 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-sky-200 outline-none">
                    </div>

                    <!-- Action (Removed Camera) -->
                    <button @click="addExpense" 
                        :disabled="!isFormValid"
                        :class="['w-full py-3 rounded-xl font-bold shadow-md transition-all', isFormValid ? 'bg-sky-500 text-white active:scale-95' : 'bg-slate-200 text-slate-400 cursor-not-allowed']">
                        儲存消費
                    </button>
                </div>

                <!-- History List -->
                <div class="space-y-3 pb-10">
                    <h3 class="font-bold text-slate-700 px-2">消費紀錄 ({{ expenses.length }} 筆)</h3>
                    <div v-if="expenses.length === 0" class="text-center text-slate-400 py-8 text-sm">尚未有紀錄，開始記帳吧！</div>
                    <div v-for="(exp, idx) in expenses" :key="idx" class="bg-white p-3 rounded-2xl shadow-sm flex items-center gap-3 border-l-4 border-sky-400">
                        <div class="w-12 h-12 bg-slate-100 rounded-xl overflow-hidden shrink-0 flex items-center justify-center text-slate-300 text-xl">
                            <i :class="getCatIcon(exp.category)"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-start">
                                <span class="text-[10px] bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded">{{ exp.dateStr }}</span>
                                <span class="text-[10px] text-slate-400">{{ getCatName(exp.category) }}</span>
                            </div>
                            <div class="font-bold text-slate-700 truncate mt-0.5">{{ exp.item }}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-slate-800">¥{{ exp.price }}</div>
                            <div class="text-xs text-emerald-500 font-medium">NT$ {{ Math.round(exp.twd) }}</div>
                        </div>
                        <button @click="handleDelete(exp.id)" class="px-2 transition-colors" :class="confirmDeleteId === exp.id ? 'text-rose-500 font-bold' : 'text-slate-300 hover:text-rose-400'">
                            <span v-if="confirmDeleteId === exp.id">確定?</span>
                            <i v-else class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </transition>

    </main>

    <!-- Bottom Navigation -->
    <nav class="glass z-30 shadow-[0_-5px_20px_rgba(0,0,0,0.03)] shrink-0 pb-safe w-full fixed bottom-0 left-0">
        <div class="flex justify-around items-center h-16 safe-bottom">
            <button @click="currentTab = 'home'" class="flex-1 flex flex-col items-center justify-center h-full space-y-1 active:scale-95 transition-transform group">
                <div :class="['text-xl px-4 py-1 rounded-full transition-colors', currentTab === 'home' ? 'text-sky-500 bg-sky-50' : 'text-slate-300']">
                    <i class="fa-solid fa-house"></i>
                </div>
                <span :class="['text-[10px] font-bold', currentTab === 'home' ? 'text-sky-600' : 'text-slate-400']">主頁</span>
            </button>
            
            <button @click="currentTab = 'plan'" class="flex-1 flex flex-col items-center justify-center h-full space-y-1 active:scale-95 transition-transform group">
                <div :class="['text-xl px-4 py-1 rounded-full transition-colors', currentTab === 'plan' ? 'text-sky-500 bg-sky-50' : 'text-slate-300']">
                    <i class="fa-solid fa-map-location-dot"></i>
                </div>
                <span :class="['text-[10px] font-bold', currentTab === 'plan' ? 'text-sky-600' : 'text-slate-400']">行程</span>
            </button>

            <button @click="currentTab = 'wallet'" class="flex-1 flex flex-col items-center justify-center h-full space-y-1 active:scale-95 transition-transform group">
                <div :class="['text-xl px-4 py-1 rounded-full transition-colors', currentTab === 'wallet' ? 'text-sky-500 bg-sky-50' : 'text-slate-300']">
                    <i class="fa-solid fa-wallet"></i>
                </div>
                <span :class="['text-[10px] font-bold', currentTab === 'wallet' ? 'text-sky-600' : 'text-slate-400']">記帳</span>
            </button>
        </div>
    </nav>

    <!-- MODALS -->
    
    <!-- 1. CHECKLIST MODAL -->
    <transition name="slide-up">
        <div v-if="showChecklistModal" class="fixed inset-0 z-50 bg-white flex flex-col h-full safe-bottom">
            <div class="bg-emerald-500 p-4 text-white shrink-0 safe-top flex justify-between items-center shadow-md">
                <h2 class="text-lg font-bold"><i class="fa-solid fa-clipboard-check mr-2"></i>行前確認清單</h2>
                <button @click="showChecklistModal = false" class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-5 bg-slate-50">
                <div class="bg-white rounded-3xl p-2 shadow-sm">
                     <div v-for="(item, idx) in checklist" :key="idx" @click="toggleCheck(idx)"
                             class="flex items-center gap-3 p-4 rounded-xl active:bg-slate-50 transition-colors cursor-pointer select-none border-b border-slate-50 last:border-0">
                            <div :class="['w-6 h-6 rounded-md flex items-center justify-center border transition-all shrink-0', 
                                item.checked ? 'bg-emerald-500 border-emerald-500 text-white' : 'bg-white border-slate-300']">
                                <i class="fa-solid fa-check text-sm" v-show="item.checked"></i>
                            </div>
                            <span :class="['font-medium transition-all', item.checked ? 'text-slate-400 line-through' : 'text-slate-700']">{{ item.text }}</span>
                        </div>
                </div>
            </div>
        </div>
    </transition>

    <!-- 2. JAPANESE MODAL (Survival Japanese) -->
    <transition name="slide-up">
        <div v-if="japaneseLevel > 0" class="fixed inset-0 z-50 bg-white flex flex-col h-full safe-bottom">
            <!-- Header -->
            <div class="bg-amber-500 p-4 text-white shrink-0 safe-top flex justify-between items-center shadow-md">
                <div class="flex items-center">
                    <button v-if="japaneseLevel > 1" @click="japaneseLevel--" class="mr-3 w-8 h-8 bg-white/20 rounded-full flex items-center justify-center">
                        <i class="fa-solid fa-arrow-left"></i>
                    </button>
                    <h2 class="text-lg font-bold">
                        <i class="fa-solid fa-comment-dots mr-2"></i>
                        <span v-if="japaneseLevel === 1">求生日文</span>
                        <span v-if="japaneseLevel === 2">{{ selectedCategory.title }}</span>
                        <span v-if="japaneseLevel === 3">請看這張卡片</span>
                    </h2>
                </div>
                <button @click="japaneseLevel = 0" class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>

            <!-- Content -->
            <div class="flex-1 overflow-y-auto p-5 bg-slate-50 flex flex-col">
                
                <!-- Level 1: Categories -->
                <div v-if="japaneseLevel === 1" class="grid grid-cols-2 gap-4">
                    <button v-for="cat in japaneseData" :key="cat.id" @click="openJpCategory(cat)"
                        class="bg-white p-6 rounded-3xl shadow-sm flex flex-col items-center justify-center gap-3 aspect-square active:scale-95 transition-transform border-b-4 border-amber-100">
                        <i :class="[cat.icon, 'text-4xl text-amber-500']"></i>
                        <span class="font-bold text-slate-700 text-lg">{{ cat.title }}</span>
                    </button>
                </div>

                <!-- Level 2: Phrase List -->
                <div v-if="japaneseLevel === 2" class="space-y-3">
                    <button v-for="p in selectedCategory.phrases" :key="p.jp" @click="openJpPhrase(p)"
                        class="w-full bg-white p-4 rounded-2xl shadow-sm border border-slate-100 text-left active:scale-95 transition-transform">
                        <div class="text-sm font-bold text-slate-500 mb-1">{{ p.ch }}</div>
                        <div class="text-lg font-bold text-slate-800 font-jp">{{ p.jp }}</div>
                    </button>
                </div>

                <!-- Level 3: Big Card -->
                <div v-if="japaneseLevel === 3" class="flex-1 flex flex-col justify-center items-center text-center p-4">
                    <div class="bg-white w-full h-full rounded-3xl shadow-lg flex flex-col justify-center items-center p-8 border-4 border-amber-400 relative">
                        <div class="absolute top-4 left-4 text-slate-400 text-sm font-bold bg-slate-100 px-3 py-1 rounded-full">
                            {{ selectedPhrase.ch }}
                        </div>
                        <div class="text-4xl md:text-5xl font-black text-slate-800 font-jp leading-normal">
                            {{ selectedPhrase.jp }}
                        </div>
                        <div class="mt-8 text-slate-400 font-bold text-xl">{{ selectedPhrase.romaji }}</div>
                    </div>
                </div>

            </div>
        </div>
    </transition>

    <!-- 3. PLAN DETAIL MODAL -->
    <transition name="slide-up">
        <div v-if="selectedItem" class="fixed inset-0 z-50 bg-white flex flex-col h-full safe-bottom">
            <!-- Modal Header -->
            <div class="relative h-48 bg-slate-200 shrink-0">
                <button @click="selectedItem = null" class="absolute top-4 right-4 z-20 w-8 h-8 bg-black/30 backdrop-blur-md rounded-full text-white flex items-center justify-center active:bg-black/50">
                    <i class="fa-solid fa-xmark"></i>
                </button>
                <div class="absolute inset-0 bg-gradient-to-br from-sky-400 to-indigo-600"></div>
                <div class="absolute bottom-0 left-0 w-full p-5 bg-gradient-to-t from-black/60 to-transparent pt-12">
                    <div class="text-white/80 text-xs font-bold mb-1 tracking-wider uppercase">
                        <i class="fa-regular fa-clock mr-1"></i>{{ selectedItem.time }}
                    </div>
                    <h2 class="text-2xl font-bold text-white leading-tight">{{ selectedItem.activity }}</h2>
                </div>
            </div>

            <!-- Modal Content -->
            <div class="flex-1 overflow-y-auto p-5 bg-slate-50 pb-20">
                <!-- TIPS -->
                <div class="bg-white rounded-2xl p-5 shadow-sm border border-slate-100 mb-6">
                    <h3 class="font-bold text-slate-800 mb-3 flex items-center text-lg">
                        <i class="fa-solid fa-lightbulb text-yellow-400 mr-2 text-xl"></i>TIPS
                    </h3>
                    <p class="text-slate-600 text-sm leading-7 whitespace-pre-line text-justify-custom">{{ selectedItem.desc }}</p>
                    
                    <div v-if="selectedItem.navButtons" class="mt-4 grid gap-2" :class="selectedItem.customGrid || 'grid-cols-2'">
                        <a v-for="btn in selectedItem.navButtons" :href="btn.url || 'https://www.google.com/maps/dir/?api=1&destination=' + encodeURIComponent(btn.query)" target="_blank"
                           :class="['flex items-center justify-center bg-slate-100 text-slate-600 py-3 rounded-xl font-bold shadow-sm active:scale-95 transition-transform hover:bg-slate-200', btn.class || '']">
                            <i :class="[btn.icon || 'fa-solid fa-location-arrow', 'text-blue-500 mr-2']"></i> {{ btn.label }}
                        </a>
                    </div>
                    <div v-else-if="(!selectedItem.subItems || selectedItem.subItems.length === 0) && (selectedItem.locationQuery || selectedItem.customNavLink)" class="mt-4">
                        <a :href="selectedItem.customNavLink || 'https://www.google.com/maps/dir/?api=1&destination=' + encodeURIComponent(selectedItem.locationQuery)" target="_blank" 
                           class="flex items-center justify-center w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-md active:scale-95 transition-transform">
                            <i class="fa-solid fa-location-arrow mr-2"></i> Google 導航
                        </a>
                    </div>
                </div>

                <!-- Sub Items -->
                <div v-if="selectedItem.subItems && selectedItem.subItems.length > 0" class="space-y-4">
                    <h3 class="font-bold text-slate-800 px-1 border-l-4 border-sky-400 pl-2">
                        {{ selectedItem.subItemTitle || '相關地點 / 選項' }}
                    </h3>
                    
                    <div v-for="(sub, idx) in selectedItem.subItems" :key="idx" class="bg-white rounded-2xl p-4 shadow-sm border border-slate-100">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-bold text-lg text-slate-700">{{ sub.name }}</h4>
                            <span v-if="sub.tag" class="text-[10px] bg-sky-100 text-sky-600 px-2 py-0.5 rounded-full font-bold">{{ sub.tag }}</span>
                        </div>
                        <p class="text-sm text-slate-600 mb-4 leading-relaxed text-justify-custom">{{ sub.desc }}</p>
                        
                        <div v-if="sub.navButtons" :class="['grid gap-2', sub.customGrid || 'grid-cols-2']">
                            <a v-for="btn in sub.navButtons" :href="btn.url || 'https://www.google.com/maps/dir/?api=1&destination=' + encodeURIComponent(btn.query)" target="_blank"
                               :class="['flex items-center justify-center bg-slate-100 text-slate-600 py-2.5 rounded-lg text-xs font-bold hover:bg-slate-200 transition-colors', btn.class || '']">
                                <i :class="[btn.icon || 'fa-solid fa-location-arrow', 'text-blue-500 mr-1.5']"></i> {{ btn.label }}
                            </a>
                        </div>
                        <div v-else class="grid grid-cols-2 gap-2">
                            <a v-if="!sub.noNav" :href="sub.navLink || 'https://www.google.com/maps/dir/?api=1&destination=' + encodeURIComponent(sub.query || sub.name)" target="_blank"
                               :class="['flex items-center justify-center bg-slate-100 text-slate-600 py-2.5 rounded-lg text-xs font-bold hover:bg-slate-200 transition-colors', !sub.link ? 'col-span-2' : '']">
                                <i class="fa-solid fa-location-arrow text-blue-500 mr-1.5"></i> 導航
                            </a>
                            <a v-if="sub.link" :href="sub.link" target="_blank"
                               :class="['flex items-center justify-center bg-sky-50 text-sky-600 py-2.5 rounded-lg text-xs font-bold hover:bg-sky-100 transition-colors', sub.noNav ? 'col-span-2' : '']">
                                <i :class="sub.linkIcon || 'fa-brands fa-google'" class="mr-1.5"></i> {{ sub.linkText || '查看介紹' }}
                            </a>
                        </div>
                    </div>
                </div>

                <!-- External Links -->
                <div v-if="selectedItem.links && selectedItem.links.length > 0" class="mt-6 space-y-2">
                    <h3 class="font-bold text-slate-800 text-sm px-1 mb-2">相關連結</h3>
                    <a v-for="link in selectedItem.links" :href="link.url" target="_blank" 
                       class="flex items-center justify-between bg-white p-3 rounded-xl border border-slate-200 text-sm font-bold text-slate-600 active:bg-slate-50">
                        <span><i :class="link.icon" class="mr-2 text-slate-400"></i>{{ link.label }}</span>
                        <i class="fa-solid fa-chevron-right text-xs text-slate-300"></i>
                    </a>
                </div>
            </div>
        </div>
    </transition>

    <!-- 4. ANALYSIS MODAL -->
    <transition name="slide-up">
        <div v-if="showAnalysis" class="fixed inset-0 z-50 bg-white flex flex-col h-full safe-bottom">
            <div class="relative bg-indigo-600 p-4 text-white shrink-0 safe-top flex justify-between items-center shadow-md">
                <h2 class="text-lg font-bold"><i class="fa-solid fa-chart-pie mr-2"></i>消費分析</h2>
                <button @click="showAnalysis = false" class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-5 bg-slate-50 pb-10">
                <div class="bg-white p-4 rounded-3xl shadow-sm mb-5 flex justify-center relative h-64">
                     <canvas id="expenseChart"></canvas>
                     <div v-if="analysisTotal === 0" class="absolute inset-0 flex items-center justify-center text-slate-300 font-bold">
                         無資料
                     </div>
                </div>

                <div class="bg-white p-5 rounded-3xl shadow-sm space-y-4">
                    <h3 class="font-bold text-slate-700 mb-2">篩選條件</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-xs text-slate-400 block mb-1">開始日期</label>
                            <select v-model="analysisFilter.start" class="w-full bg-slate-50 rounded-lg p-2 text-sm font-bold">
                                <option v-for="d in dateOptions" :value="d.value">{{ d.label }}</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-xs text-slate-400 block mb-1">結束日期</label>
                            <select v-model="analysisFilter.end" class="w-full bg-slate-50 rounded-lg p-2 text-sm font-bold">
                                <option v-for="d in dateOptions" :value="d.value">{{ d.label }}</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="text-xs text-slate-400 block mb-2">顯示分類</label>
                        <div class="grid grid-cols-3 gap-2">
                            <label v-for="cat in categories" :key="cat.id" class="checkbox-wrapper cursor-pointer">
                                <input type="checkbox" v-model="analysisFilter.categories" :value="cat.id" class="hidden">
                                <div class="py-2 px-1 rounded-xl text-xs font-bold text-center border-2 border-slate-100 bg-slate-50 text-slate-400 transition-all">
                                    {{ cat.name }}
                                </div>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="mt-5 text-center">
                    <div class="text-xs text-slate-400 mb-1">篩選總金額</div>
                    <div class="text-3xl font-bold text-indigo-600 font-mono">¥{{ analysisTotal.toLocaleString() }}</div>
                    <div class="text-sm text-emerald-500 font-medium">≈ NT$ {{ Math.round(analysisTotal * exchangeRate).toLocaleString() }}</div>
                </div>
            </div>
        </div>
    </transition>

</div>

<script>
const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

Chart.register(ChartDataLabels);

createApp({
    setup() {
        const currentTab = ref('home'); // Default to Home
        const activeDay = ref(0);
        const selectedItem = ref(null);
        const showAnalysis = ref(false);
        
        // Home States
        const showChecklistModal = ref(false);
        const japaneseLevel = ref(0);
        const selectedCategory = ref(null);
        const selectedPhrase = ref(null);
        const calcJpy = ref('');
        const calcTwd = ref('');
        const exchangeRate = ref(0.21);

        // Data
        const expenses = ref([]);
        const confirmDeleteId = ref(null);
        const checklist = ref([
            { text: '護照 (有效期6個月以上)', checked: false },
            { text: 'Visit Japan Web 填寫', checked: false },
            { text: '網卡 / Roaming 開通', checked: false },
            { text: '日幣現金 (部分鄉下店家只收現金)', checked: false },
            { text: '信用卡 (海外回饋高)', checked: false },
            { text: '牙刷牙膏 (環保)', checked: false },
            { text: '保暖衣物 (發熱衣、手套、毛帽)', checked: false },
            { text: '個人常備藥品 (感冒、腸胃)', checked: false },
            { text: '行動電源 & 充電線', checked: false },
        ]);
        const notes = ref('');
        
        // New Expense
        const newExpense = ref({ dateStr: '', category: '', item: '', price: '' });

        const dateOptions = [
            { label: '1/19 (Day 0)', value: '2026-01-19' },
            { label: '1/20 (Day 1)', value: '2026-01-20' },
            { label: '1/21 (Day 2)', value: '2026-01-21' },
            { label: '1/22 (Day 3)', value: '2026-01-22' },
            { label: '1/23 (Day 4)', value: '2026-01-23' },
            { label: '1/24 (Day 5)', value: '2026-01-24' },
            { label: '1/25 (Day 6)', value: '2026-01-25' },
            { label: '1/26 (Day 7)', value: '2026-01-26' },
        ];

        const categories = [
            { id: 'food', name: '飲食', icon: 'fa-solid fa-utensils', color: '#f59e0b' },
            { id: 'transport', name: '交通', icon: 'fa-solid fa-train-subway', color: '#3b82f6' },
            { id: 'shopping', name: '購物', icon: 'fa-solid fa-bag-shopping', color: '#ec4899' },
            { id: 'entertainment', name: '娛樂', icon: 'fa-solid fa-ticket', color: '#8b5cf6' },
            { id: 'misc', name: '雜支', icon: 'fa-solid fa-coins', color: '#64748b' },
        ];

        const analysisFilter = ref({
            start: '2026-01-19',
            end: '2026-01-26',
            categories: ['food', 'transport', 'shopping', 'entertainment', 'misc']
        });
        
        let chartInstance = null;

        // Survival Japanese Data
        const japaneseData = [
            {
                id: 'restaurant', title: '餐廳用餐', icon: 'fa-solid fa-utensils',
                phrases: [
                    { ch: '請問有中文菜單嗎？', jp: '中国語のメニューはありますか？', romaji: 'Chuugokugo no menyu wa arimasuka?' },
                    { ch: '我不吃肉(素食)。', jp: '私は肉を食べません。', romaji: 'Watashi wa niku o tabemasen.' },
                    { ch: '請給我水。', jp: 'お水をください。', romaji: 'Omizu o kudasai.' },
                    { ch: '請問廁所在哪裡？', jp: 'トイレはどこですか？', romaji: 'Toire wa doko desuka?' },
                    { ch: '我要結帳。', jp: 'お会計をお願いします。', romaji: 'Okaikei o onegaishimasu.' }
                ]
            },
            {
                id: 'hotel', title: '住宿飯店', icon: 'fa-solid fa-bed',
                phrases: [
                    { ch: '我要辦理入住。', jp: 'チェックインをお願いします。', romaji: 'Chekkuin o onegaishimasu.' },
                    { ch: '可以寄放行李嗎？', jp: '荷物を預かってもらえますか？', romaji: 'Nimotsu o azukatte moraemasuka?' },
                    { ch: '有Wi-Fi嗎？', jp: 'Wi-Fiはありますか？', romaji: 'Wifi wa arimasuka?' },
                    { ch: '請幫我叫計程車。', jp: 'タクシーを呼んでください。', romaji: 'Takushii o yonde kudasai.' }
                ]
            },
            {
                id: 'transport', title: '交通移動', icon: 'fa-solid fa-train',
                phrases: [
                    { ch: '這班車去仙台站嗎？', jp: 'この電車は仙台駅に行きますか？', romaji: 'Kono densha wa Sendai-eki ni ikimasuka?' },
                    { ch: '我要去這個地方。', jp: 'ここに行きたいです。', romaji: 'Koko ni ikitai desu.' },
                    { ch: '請在這停車。', jp: 'ここで止めてください。', romaji: 'Koko de tomete kudasai.' }
                ]
            },
            {
                id: 'shopping', title: '購物結帳', icon: 'fa-solid fa-bag-shopping',
                phrases: [
                    { ch: '多少錢？', jp: 'いくらですか？', romaji: 'Ikura desuka?' },
                    { ch: '可以刷卡嗎？', jp: 'クレジットカードは使えますか？', romaji: 'Kurejitto kaado wa tsukaemasuka?' },
                    { ch: '可以免稅嗎？', jp: '免税できますか？', romaji: 'Menzei dekimasuka?' },
                    { ch: '請給我袋子。', jp: '袋をください。', romaji: 'Fukuro o kudasai.' }
                ]
            }
        ];

        // Itinerary (Preserved)
        const itinerary = [
            {
                shortDate: '1/19', weekday: 'Day 0', title: '出發日', location: '桃園 → 羽田', stay: '機上 / 平和島溫泉',
                schedule: [
                    { time: '20:55', activity: '桃園機場起飛', desc: '搭乘樂桃 MM860。此為紅眼班機，機上無供餐。請提前 2 小時抵達機場辦理登機。', highlight: true, noDetail: true },
                    { time: '00:50', activity: '抵達羽田機場', desc: '抵達後不需著急，慢慢下機跟隨指示通關。若有填寫 Visit Japan Web，通關會更快速。', noDetail: true },
                    { time: '02:40', activity: '接駁車往平和島', cardDesc: '【需30天前預約】\n預約 02:40 班次 (若提早出關可試 01:40)。抵達後寄放行李，換洗衣物請隨身攜帶。', links: [{url:'https://www.heiwajima-onsen.jp/', label:'平和島溫泉官網 (預約)', icon:'fa-solid fa-globe'}, {url:'https://upssmile.com/52941/heiwajima', label:'部落格：接駁車搭乘路線圖', icon:'fa-solid fa-map-location-dot'}, {url:'https://cruisetraveljessica.com/journey/heiwajima', label:'平和島簡介 (部落格)', icon:'fa-solid fa-book-open'}], desc: `【接駁車與預約資訊】\n您預約的是「02:40」的班次。\n如果飛機提早抵達且通關順利，可以去櫃檯碰碰運氣，看「01:40」的班次有無空位可搭乘。車程約15分鐘。\n\n【抵達後流程】\n1. 先去寄放大型行李。\n2. **務必把換洗衣物及盥洗用具隨身帶著**。\n\n【休息建議】\n畢竟是半夜，抵達後請視身體疲勞程度決定：\n- 累了：簡單沖洗後直接去休息區睡覺。\n- 還好：可以慢慢享受溫泉放鬆一下再睡。\n\n【早餐資訊】重要！\n附贈的早餐時段為 **07:00 - 08:30**。\n建議可以先吃完早餐，休息30分鐘~1小時後，再洗個澡開啟美好的一天。` }
                ]
            },
            {
                shortDate: '1/20', weekday: 'Day 1', title: '東京淺草美食遊', location: '東京', stay: '神田貝爾肯飯店',
                schedule: [
                    { time: '09:30', activity: '前往飯店寄放行李', desc: '交通移動：平和島 -> 神田貝爾肯飯店 (約1小時)。\n先去飯店櫃檯寄放行李，輕裝出發去吃午餐。', locationQuery: 'Belken Hotel Kanda' },
                    { time: '11:30', activity: '午餐三選一', desc: '【已預訂 11:30】\n大家午餐都已經安排好了。我們從飯店出發步行，會先經過「Ome Farm (素食)」，接著是「太鼓茶屋 (生魚片)」與「丸文 (鰻魚飯)」。請依序前往各自的餐廳用餐。', tags: ['美食'], highlight: true, subItemTitle: '餐廳 (依抵達順序)', subItems: [{ name: 'Ome Farm Kitchen', tag: '素食', desc: '由東京近郊有機農場直營的餐廳。主打「Farm to Table」，提供新鮮蔬菜製作的咖哩、沙拉與熟食，非常適合素食者或想吃清淡一點的人。', query: 'Ome Farm Kitchen Tokyo', linkText: '店家IG/介紹' }, { name: '太鼓茶屋', tag: '生魚片', desc: '知名的生魚片吃到飽 (限時50分鐘)。這裡以每天從豐洲市場直送的新鮮海鮮聞名，生魚片堆得像山一樣高任你夾。記得要拿整理券，且不要浪費食物喔。', query: 'Taiko Chaya Tokyo' }, { name: '丸文鰻魚飯', tag: '鰻魚', desc: '創業超過70年的老字號。這裡的鰻魚使用關東風格，先蒸後烤，口感軟嫩，醬汁鹹甜適中，是補充體力的最佳選擇。', query: 'Marubun Unagi Tokyo', linkText: '食記/地圖' }] },
                    { time: '13:30', activity: '淺草深度漫遊', desc: '午後時光在充滿下町風情的淺草漫步。從求姻緣的神社到熱鬧的仲見世通，體驗最道地的江戶文化。', tags: ['景點', '購物'], subItemTitle: '必訪景點 (依路線)', subItems: [{ name: '今戶神社', tag: '求姻緣', desc: '招財貓發源地之一，求姻緣非常有名的能量景點。記得摸摸社內的「石撫貓」雕像，據說設為手機桌布會帶來好運喔！', query: 'Imado Shrine', linkText: '部落格介紹', link: 'https://look2uptravel.com/tokyo-imado-jinja/' }, { name: '淺草寺', tag: '地標', desc: '東京最古老的寺廟。進正殿前別忘了在「常香爐」把香煙撥向自己身體不舒服的地方。也可以求一支籤，抽到凶記得綁在架上化解。', query: 'Sensoji Temple', linkText: '參拜攻略', link: 'https://www.senso-ji.jp/chinese/han/' }, { name: '仲見世通商店街', tag: '逛街', desc: '連接雷門與淺草寺的熱鬧街道。必吃人形燒、炸肉餅、菠蘿麵包。請注意：大部分店家禁止邊走邊吃，請在店旁定點吃完。', query: 'Nakamise Shopping Street', linkText: '美食地圖', link: 'https://www.bring-you.info/zh-tw/nakamise-shopping-street' }, { name: '雷門', tag: '拍照', desc: '淺草寺的總門，巨大的紅色燈籠重達700公斤。左右兩側是風神與雷神。這是觀光客必拍的打卡點。', query: 'Kaminarimon', linkText: '歷史介紹', link: 'https://matcha-jp.com/tw/997' }, { name: '吉備子屋', tag: '必買', desc: '位於仲見世通旁的小店，這裡有賣傳說中的「桃鈴」。桃子在風水中有避邪與帶來好運的含義。非常搶手，有緣才買得到！', navLink: 'https://maps.app.goo.gl/N4Z8pZLRQ7GGK4Hj6', linkText: '購買心得', link: 'https://tw.trip.com/moments/detail/tokyo-294-130958970/' }] },
                    { time: '17:00', activity: '晚餐：炸牛排', desc: '晚餐在淺草享用。推薦著名的炸牛排，或是評價極高的素食餐廳。', subItemTitle: '用餐選擇', subItems: [{ name: '淺草炸牛排 (Asakusa Gyukatsu)', tag: '排隊店', desc: '將牛排裹上麵包粉快速油炸，內部保持半生熟。可在石板上煎到喜歡的熟度。若本店人多，請前往分店。', navButtons: [{ label: '導航：本店', query: 'Asakusa Gyukatsu' }, { label: '導航：分店', query: 'Asakusa Gyukatsu branch' }, { label: '食記分享', icon: 'fa-solid fa-utensils', url: 'https://sliptojapan.com/asakusa-gyuukatsu/', class: 'col-span-2 bg-amber-50 text-amber-600 hover:bg-amber-100' }] }, { name: 'Marugoto Vegan', tag: '素食', query: 'Marugoto Vegan Dining Asakusa', desc: '全素食餐廳，不含五辛。提供素漢堡、天婦羅咖哩與無麩質甜點，是素食者的天堂。', linkText: '食記介紹', link: 'https://dining.marugotovegan.com/chinese/' }, { name: 'Injoy 悦納', tag: '素食', query: 'Injoy Asakusa', desc: '位於淺草的素食餐廳，招牌是素食擔擔麵與日式定食，環境清幽舒適。', linkText: '食記介紹', link: 'https://kitlindacat.com/2025/07/17/tokyo_vegan_restaruant/' }] },
                    { time: '19:00', activity: '晴空塔夜景', desc: '【需30天前購票】世界最高的自立式電波塔。從展望台可以360度俯瞰東京夜景。', links: [{url:'https://www.tokyo-skytree.jp/', label:'晴空塔官網', icon:'fa-solid fa-tower-observation'}, {url:'https://www.saydigi.com/2024/09/1436369.html', label:'部落格：夜景攻略', icon:'fa-solid fa-camera'}, {url:'https://www.klook.com/zh-TW/activity/41352-tokyo-skytree/?aid=api%7C13694%7C106d153f6cb6418c9397396cb-643149%7Cpid%7C643149&aff_pid=643149&aff_sid=&aff_adid=1078950&utm_medium=affiliate-alwayson&utm_source=network&utm_campaign=13694&utm_term=643149&utm_content=&aff_klick_id=115086217526-api%7C13694%7C106d153f6cb6418c9397396cb-643149%7Cpid%7C643149-1078950-db7dc21', label:'Klook 購票', icon:'fa-solid fa-ticket'}], locationQuery: 'Tokyo Skytree' },
                    { time: '21:00', activity: '回飯店 & 宵夜', desc: '回到神田貝爾肯飯店 Check-in。如果肚子餓，飯店附近有一間「神田家系拉麵」，濃厚豚骨醬油湯底配上粗麵，營業到凌晨。提醒：隔天沒有附早餐，請在便利商店買好麵包飲料。', locationQuery: 'Kanda Ramen Waizu' }
                ]
            },
            {
                shortDate: '1/21', weekday: 'Day 2', title: '前進銀山溫泉', location: '山形', stay: '銀山溫泉附近',
                schedule: [
                    { time: '08:30', activity: '從東京車站前往大食田車站', desc: '搭 09:24 山形新幹線往大石田站 (12:17到)。新幹線的車票已經訂好了!', highlight: true, locationQuery: 'Tokyo Station' },
                    { time: '12:30', activity: '大石田站午餐', desc: '抵達大石田站。大石田以「蕎麥麵」聞名，有許多名店。吃完後記得去公車等候室寄放行李【1件/500円】。', locationQuery: 'Oishida Station', subItems: [{ name: 'そば処 ふうりゅう', tag: '車站內', desc: '位於車站內的便利選擇。推薦這裡的「板蕎麥麵」，份量十足，麵條香氣濃郁，搭配炸得酥脆的野菜天婦羅，沾醬是傳統的鰹魚醬油風味。', query: 'Soba restaurant Furyu Oishida', linkText: '板蕎麥麵介紹', link: 'https://www.tokyo.taipei/2022/01/furyu.html' }] },
                    { time: '14:30', activity: '搭計程車往銀山溫泉', cardDesc: '【已預約 9人座】\n請在公車等候室找司機報到。', desc: `【車資說明】\n1. 去程：1車 / 11,610円\n2. 回程：1車 / (11,610 + 1,800)円 (司機會幫忙把行李一起載過來，直接從銀山溫泉到飯店)\n3. 總計：25,020円 (到銀山溫泉要先付)\n\n【重要】\n司機會給【付款證明卡片】，回程上車時不用再付，把卡片給司機即可。`, highlight: true },
                    { time: '15:00', activity: '銀山溫泉散策', desc: '彷彿穿越時空來到大正時代。白雪覆蓋的傳統木造旅館，傍晚瓦斯燈亮起時最為夢幻。', tags: ['必去', '拍照'], subItemTitle: '必訪清單', subItems: [{ name: '銀山溫泉區', tag: '拍照', desc: '大正浪漫風情，神隱少女場景。白雪、川流與古老木造建築交織出的絕美景色。', linkText: '散策地圖', link: 'https://journey.tw/ginzan-onsen/', noNav: true }, { name: '野川豆腐屋', tag: '散步美食', desc: '創業百年的手工豆腐店。推薦「立食豆腐」(站著吃)，口感綿密軟嫩，豆香濃郁，淋上特製醬油非常美味。', query: 'Nogawa Tofu' }, { name: '布丁 酒茶房クリエ', tag: '甜點', desc: '逛累了可以來這休息。這裡的手工布丁口感滑順，也有提供充滿大人味的酒香可可。', navLink: 'https://maps.app.goo.gl/VNb9TdvJPs3Dx4LZ8' }, { name: '西塚菓子舖', tag: '伴手禮', desc: '溫泉街上的老字號，推薦現炸的咖哩麵包與溫泉饅頭。', navLink: 'https://maps.app.goo.gl/ssbNjLY2JerYV3sB7' }] },
                    { time: '18:00', activity: '集合搭車去飯店', desc: '回到下車地點搭乘預約好的9人座車前往今晚住宿。記得出示付款證明卡片。', highlight: true, noDetail: true },
                    { time: '19:30', activity: '飯店晚餐 & 溫泉', desc: '如果還餓的話，在飯店享用晚餐 (20:00最後點餐)。飯後休息一下再去泡湯，洗去旅途疲勞。', noDetail: true }
                ]
            },
            {
                shortDate: '1/22', weekday: 'Day 3', title: '山形市區歷史遊', location: '山形', stay: '山形民宿',
                schedule: [
                    { time: '09:00', activity: '搭車往山形站', desc: '計程車 (已預訂-約1800円)。轉搭 09:31 JR (已訂票)前往山形站 (10:02到)。抵達後先寄放行李。', links: [{url:'https://cloak.ecbo.io/zh-TW/jpn/city/yamagata/119', label:'投幣式置物櫃', icon:'fa-solid fa-suitcase'}] },
                    { time: '10:30', activity: '神社與文翔館', desc: '早晨的山形市區漫步，探訪歷史古蹟。', tags: ['歷史'], subItemTitle: '參觀景點', subItems: [{ name: '歌懸稻荷神社', desc: '位於市中心的朱紅色神社，祈求生意興隆與五穀豐收。雖然不大，但氛圍寧靜莊嚴。', query: 'Utakake Inari Shrine', linkText: '參拜介紹', link: 'https://sixteen-chateau.blogspot.com/2025/11/utakakeinari.html' }, { name: '諏訪神社', desc: '就在歌懸稻荷神社附近，是當地的守護神。', navLink: 'https://maps.app.goo.gl/211xR3Z38DbVkh2B6' }, { name: '七日町', desc: '充滿懷舊風情的商店街，有許多老店鋪。', linkText: '漫步簡介', link: 'https://nancyik2001.pixnet.net/blog/post/226767941', noNav: true }, { name: '文翔館', desc: '舊山形縣廳與縣議會，是英國文藝復興風格的紅磚建築。內部保留了大正時代的豪華裝潢。免費參觀！【1250前離開】', query: 'Bunshokan', linkText: '歷史介紹', link: 'https://journey.tw/gakushubunka/' }] },
                    { time: '13:00', activity: '午餐：燒肉名匠山牛', desc: '來山形怎能不吃山形牛！這家店由肉舖直營，肉質鮮美且價格合理。午間套餐CP值很高。素食者可點烤蔬菜盤與沙拉。【餐廳1430休息】', highlight: true, customNavLink: 'https://maps.app.goo.gl/XH3SroBz24AGDrAz6', links: [{url:'https://immay.tw/yamagata_yamagyu/', label:'部落格食記', icon:'fa-solid fa-utensils'}, {url:'https://www.yamagyu.com/menu/', label:'菜單', icon:'fa-solid fa-book-open'}] },
                    { time: '14:30', activity: '霞城公園', desc: '山形城跡整備而成的公園，名列日本百大名城。可以看到復原後的「二之丸東大手門」與最上義光騎馬像。公園腹地廣大，很適合散步消化。【預計1600離開】', locationQuery: 'Kajo Park', links: [{url:'https://taitai.com.tw/japantrip-yamagatatravel-laden-sie/', label:'霞城遊記', icon:'fa-solid fa-camera'}] },
                    { time: '16:00', activity: '超市採買', desc: '隨意逛逛，購買一些食物，才能在民宿煮接下來2天的早餐。聽說山形米非常好吃，記得買一點！', subItemTitle: '採買地點', subItems: [{ name: 'Jupiter', desc: '位於 S-PAL 1樓。以進口食品與咖啡豆為主，也有許多乾貨。', tag: '乾貨', navLink: 'https://maps.app.goo.gl/zYM5vYhynwyWzfCX6' }, { name: 'エスパル山形銘菓品店', desc: '位於 S-PAL 2樓。這裡比較像特產店集合，但也有肉、魚還有蔬菜可以買。', tag: '生鮮', navLink: 'https://maps.app.goo.gl/QVJeee48wk82o6qQ7' }] },
                    { time: '17:30', activity: '晚餐：神室鐵板燒', desc: '美味鐵板燒。素食可點香煎卡門貝爾起司或鐵板食蔬。', customNavLink: 'https://maps.app.goo.gl/ymkZmsEPHwQpCfwg6' },
                    { time: '19:00', activity: '前往民宿', desc: '民宿老闆會來山形車站接送 (車程約10分鐘)。記得跟老闆確認明天早上的出門時間【預計0900之前】。', subItemTitle: '參觀景點', subItems: [{ name: '霞城中央大樓景觀台', desc: '位於霞城中央大樓 24F，可以免費眺望山形市夜景。離車站很近。', navLink: 'https://maps.app.goo.gl/snfzPfZwjGVRHSjr7', link: 'https://journey.tw/kajo-central/', linkText: '景觀台介紹' }] }
                ]
            },
            {
                shortDate: '1/23', weekday: 'Day 4', title: '藏王樹冰絕景', location: '藏王', stay: '山形民宿',
                schedule: [
                    { time: '09:00', activity: '出發往藏王', desc: '早餐自理。民宿老闆接送。記得帶「浴巾」，下午可能會去泡溫泉。', highlight: true, noDetail: true },
                    { time: '10:30', activity: '藏王樹冰 (日)', cardDesc: '搭乘藏王纜車前往山頂，觀賞世界罕見的「樹冰」奇景。', desc: `【參觀重點與流程】\n1. **購票與搭乘**：\n   前往「藏王纜車山麓站」購買來回票 (4200円/人)。\n   路線：山麓站 -> 樹冰高原站 (可在此稍作停留拍照) -> 地藏山頂站。\n   隨著高度上升，針葉林逐漸變成白色的冰怪，景色非常震撼。\n\n2. **山頂必看**：\n   **藏王地藏尊**：出站即可看到。高達2.46公尺，但在雪季往往被埋到只剩一顆頭。\n   **開運之鐘**：位於頂樓展望台，敲響鐘聲祈求好運 (也是戀人聖地)。\n   **山頂餐廳**：若人多可不吃，下山再吃。\n\n3. **時間規劃**：\n   整體行程約 1-2 小時。\n   **預計 13:00 - 14:00 下山**，前往溫泉街午餐。`, tags: ['必看'], noDetail: false },
                    { time: '14:00', activity: '高湯溫泉街', desc: '下山後在高湯通溫泉街覓食與休息。體驗知名的藏王溫泉與神社。', subItemTitle: '溫泉與景點', subItems: [{ name: '高湯溫泉', desc: '藏王溫泉泉質為強酸性硫磺泉，被譽為「美容溫泉」。高湯通有三個無人公共浴場，是當地人也愛去的地方。', navButtons: [{ label: '下湯', url: 'https://maps.app.goo.gl/quhEptSSF4fFWKfr8' }, { label: '川原湯', url: 'https://maps.app.goo.gl/MzuTG8W9nobMAHEL6' }, { label: '上湯', url: 'https://maps.app.goo.gl/NEs6GMskGLxg3Yxs9' }, { label: '溫泉介紹', icon: 'fa-solid fa-book-open', url: 'https://matcha-jp.com/cn/11671#:~:text=%E5%85%AC%E5%85%B1%E6%B5%B4%E5%AE%A4%20%E8%97%8F%E7%8E%8B%E6%B8%A9%E6%B3%89%E7%9A%84%E6%B3%89%E8%B4%A8%E4%B8%BA%E5%BC%BA%E9%85%B8%E6%80%A7%E7%A1%AB%E7%A3%BA%E6%B3%89%EF%BC%8C%E8%A2%AB%E8%AA%89%E4%B8%BA%E2%80%9C%E7%BE%8E%E5%AE%B9%E6%B8%A9%E6%B3%89%E2%80%9D%E3%80%82%20%E9%AB%98%E6%B1%A4%E9%80%9A%E7%9A%84%E5%85%AC%E5%85%B1%E6%B5%B4%E5%9C%BA%E6%9C%89%E4%B8%8A%E6%B1%A4%E3%80%81%E4%B8%8B%E6%B1%A4%E3%80%81%E6%B2%B3%E5%8E%9F%E6%B1%A4%E3%80%82%20%E6%98%AF%E6%A0%B9%E6%A4%8D%E4%BA%8E%E5%BD%93%E5%9C%B0%E3%80%81%E5%BD%93%E5%9C%B0%E4%BA%BA%E7%BB%8F%E5%B8%B8%E4%BD%BF%E7%94%A8%E7%9A%84%E6%B8%A9%E6%B3%89%E3%80%82' }], customGrid: 'grid-cols-3' }, { name: '酢川溫泉神社', desc: '守護藏王溫泉的神社。爬上長長的石階後，可以俯瞰溫泉街的景色。上湯走過去約10分鐘。', navLink: 'https://maps.app.goo.gl/oZg4Q8Vw9dn7VpD97' }, { name: '藏王的大ちゃん', tag: '日式', desc: '招牌是燉牛肉飯，肉質軟爛入味。也有拉麵和煎餃。', navLink: 'https://maps.app.goo.gl/YFy3SKvv3RNZKcpNA' }, { name: 'Have a Good Slice', tag: '西式', desc: '美式披薩店，也有好吃的起司蛋糕。', navLink: 'https://maps.app.goo.gl/7Q5nHi1qDm9WrgVb7' }, { name: '音茶屋', tag: '咖啡', desc: '氣氛很好的咖啡廳，湯咖哩很有名。', query: 'Otochaya' }, { name: 'しばママのお店', tag: '素食', desc: '溫馨的小店，是附近唯一查到有提供素食餐點的地方。', navLink: 'https://maps.app.goo.gl/jpARBXoBf1oPbVPj6' }] },
                    { time: '16:30', activity: '樹冰點燈', desc: '再次買票搭1700纜車上山 (1人/4400円)。夜晚的樹冰在彩色燈光照射下，呈現出與白天截然不同的神秘氛圍，像是一群在雪地行走的怪獸。(1900前回到山下，由民宿老闆載去吃晚餐)', highlight: true },
                    { time: '20:00', activity: '晚餐：登起波', desc: '【已預約，含素食】來到山形就是要吃米澤牛！這家是米澤牛的老字號名店，壽喜燒醬汁濃郁，牛肉入口即化。完食後叫計程車回民宿', locationQuery: 'Yonezawagyu Tokiwa Yamagata', subItems: [{ name: '登起波 (Tokiwa)', desc: '米澤牛壽喜燒', navButtons: [{ label: '米澤牛導航', url: 'https://maps.app.goo.gl/bX6MdqxzegmUwvHm9' }, { label: '食記分享', icon: 'fa-solid fa-utensils', url: 'https://nicklee.tw/3261/yamagata-tokiwa/' }] }, { name: '回程', desc: '搭計程車回民宿', navButtons: [{ label: '民宿導航', url: 'https://maps.app.goo.gl/FfcLQJKCPoVEGYBB9' }] }] },
                    { time: '21:30', activity: '晚安', desc: '請將行李打包好，明天一早0740出門。', highlight: true, noDetail: true }
                ]
            },
            {
                shortDate: '1/24', weekday: 'Day 5', title: '仙台名勝巡禮', location: '仙台', stay: '仙台阿爾蒙特飯店',
                schedule: [
                    { time: '08:03', activity: '搭巴士往仙台', desc: '早餐自理。從山形搭乘高速巴士前往仙台 (約70分鐘)。抵達後先去仙台阿爾蒙特飯店寄放行李(預計0930前完成)。', links: [{ label: '高速巴士介紹', url: 'https://travelerduck.com/sendai-yamakobus/', icon: 'fa-solid fa-bus' }, { label: '飯店位置導航', url: 'https://maps.app.goo.gl/txVKZhsrg8mHze746', icon: 'fa-solid fa-hotel' }] },
                    { time: '09:30', activity: '仙台車站', desc: '【必辦事項 & 必吃甜點】\n1. **購買仙台2日券**：前往車站2樓「JR東日本旅行服務中心」購買 (2720円)。\n2. **甜點時間**：必買車站內的「蘋果派」與「毛豆奶昔」，補充糖分準備開始今天的行程！', links: [{ label: '蘋果派位置', url: 'https://maps.app.goo.gl/P6YuhvXwrDHXCASH8', icon: 'fa-solid fa-apple-whole' }, { label: '毛豆奶昔位置', url: 'https://maps.app.goo.gl/wCQQrjwWo4S6sgfr6', icon: 'fa-solid fa-blender' }] },
                    { time: '10:30', activity: '櫻岡大神宮', desc: '位於西公園內，雖然不是櫻花季，但神社建築精美，雪景也別有一番風味。', customNavLink: 'https://maps.app.goo.gl/PtKL7TVGoowVUPSz8', links: [{ label: '參拜介紹', url: 'https://look2uptravel.com/post-356264014/', icon: 'fa-solid fa-book-open' }] },
                    { time: '11:30', activity: '午餐分頭行動', desc: '大家口味不同，中午分頭行動，吃飽後仙台車站集合。', subItemTitle: '餐廳選擇', subItems: [{ name: 'Ohisamaya', tag: '素食', desc: '隱身在巷弄二樓的有機餐廳。提供精緻的蔬菜定食。', navButtons: [{ label: '導航', query: 'Ohisamaya Sendai' }, { label: '菜單參考', url: 'https://tabelog.com/tw/miyagi/A0401/A040101/4000115/', icon: 'fa-solid fa-utensils' }] }, { name: '牛舌專門店 司', tag: '牛舌', desc: '仙台牛舌名店眾多，這家口感偏軟嫩，炭烤香氣十足。推薦點定食並加點山藥泥，拌飯吃超級搭！', navButtons: [{ label: '導航', url: 'https://maps.app.goo.gl/Rxv7fjGCU3weP8tc8' }, { label: '菜單參考', url: 'https://tabelog.com/tw/miyagi/A0401/A040101/4018920/dtlmenu/', icon: 'fa-solid fa-utensils' }, { label: '食記分享', url: 'https://www.bigfang.tw/blog/post/gyutan-tsukasa-sendai-west', icon: 'fa-solid fa-book-open', class: 'col-span-2 bg-amber-50 text-amber-600' }] }] },
                    { time: '12:45', activity: '觀光巴士巡遊', desc: '搭乘復古造型的 Loople Sendai 觀光巴士(16號乘車處)，輕鬆遊覽仙台市區名勝。', subItemTitle: '停靠景點', subItems: [{ name: 'Loople Sendai 觀光巴士', desc: '復古造型的循環巴士，一日券很方便。', navButtons: [{ label: '觀光巴士介紹', url: 'https://loople-sendai.jp/tw/', icon: 'fa-solid fa-bus' }] }, { name: '瑞鳳殿', desc: '戰國名將伊達政宗的靈廟。建築風格華麗，使用了大量的金箔與鮮豔色彩，展現了桃山文化的精髓。', query: 'Zuihoden', navButtons: [{ label: '導航', query: 'Zuihoden' }, { label: '必看景點', url: 'https://tohoku.letsgojp.com/archives/9064/', icon: 'fa-solid fa-star' }] }, { name: '仙台城跡', desc: '又稱青葉城。雖然城池已毀，但著名的「伊達政宗騎馬像」依然俯瞰著整個仙台市區，是拍夜景的絕佳地點。', query: 'Sendai Castle Ruins', navButtons: [{ label: '導航', query: 'Sendai Castle Ruins' }, { label: '景點介紹', url: 'https://tohoku.letsgojp.com/archives/23084/', icon: 'fa-solid fa-landmark' }] }, { name: '大崎八幡宮', desc: '由伊達政宗下令建造，是日本國寶級建築。黑漆底色配上金箔裝飾，氣勢非凡。', query: 'Osaki Hachimangu', navButtons: [{ label: '導航', query: 'Osaki Hachimangu' }, { label: '參拜攻略', url: 'https://www.bring-you.info/zh-tw/osaki-hachimangu', icon: 'fa-solid fa-person-praying' }] }] },
                    { time: '18:30', activity: '晚餐', desc: '【已預約1830】鰻魚飯，素食吃 Millis 以色列料理 (Falafel口袋餅很好吃)。', subItemTitle: '餐廳選擇', subItems: [{ name: 'Unaki (鰻魚飯)', desc: '點小份的就好，待會還要吃餃子！', navButtons: [{ label: '導航', url: 'https://maps.app.goo.gl/VqiMSSMfFoD6H7RU9' }, { label: '菜單介紹', url: 'https://tabelog.com/tw/miyagi/A0401/A040101/4000083/dtlmenu/', icon: 'fa-solid fa-book-open' }] }, { name: 'Millis -Shisha bar＆café', desc: '充滿異國風情的以色列料理，提供美味的 Falafel 與鷹嘴豆泥，也有水煙體驗。', navButtons: [{ label: '導航', url: 'https://maps.app.goo.gl/r78yYo3tqWtSu6sa7' }] }] },
                    { time: '19:30', activity: '夜間散策&返回飯店', desc: '吃完餃子後可以去 SS30 大樓的展望台 (免費) 看夜景，或是去逛藥妝店、電器行。', subItemTitle: '逛街地圖', subItems: [{ name: '餃子元祖 八仙', desc: '仙台必吃的老字號餃子店，外皮酥脆內餡多汁。', navButtons: [{ label: '導航', url: 'https://maps.app.goo.gl/mPpFxN1W5RxhwnAH7' }] }, { name: '大國藥妝', desc: '', navButtons: [{ label: '導航', url: 'https://maps.app.goo.gl/YEstk3VKFTeqy3xu8' }] }, { name: 'SS30展望ロビー', desc: '開放至 23:00，免費欣賞仙台百萬夜景的好去處。', navButtons: [{ label: '導航', url: 'https://maps.app.goo.gl/Dfg9keCwYYrsZwZ5A' }] }, { name: '唐吉軻德', desc: '', navButtons: [{ label: '導航', url: 'https://maps.app.goo.gl/Y9eZZF1QbFDjib1p6' }] }, { name: '友都八喜仙台', desc: '', navButtons: [{ label: '導航', url: 'https://maps.app.goo.gl/zY62NnMBjmrUKDd' }] }] }
                ]
            },
            {
                shortDate: '1/25', weekday: 'Day 6', title: '松島海岸', location: '松島', stay: '仙台阿爾蒙特飯店',
                schedule: [
                    { time: '06:30', activity: '飯店早餐', desc: '需跟飯店現場加購 (1980円/人)。享受豐盛的自助餐後，預計 08:00 準時出發。', links: [{ label: '豪華早餐介紹', url: 'https://wind.suzukihiro.tw/almont-sendai/', icon: 'fa-solid fa-utensils' }] },
                    { time: '08:00', activity: '金蛇水神社', desc: '東北最強的財運能量景點！\n交通：先搭地鐵到「岩沼駅」，再轉計程車前往。預計 10:00 離開。', highlight: true, locationQuery: 'Kanahebisui Shrine', links: [{ label: '金蛇水神社介紹', url: 'https://amigo0728.pixnet.net/blog/post/71046589', icon: 'fa-solid fa-book-open' }] },
                    { time: '12:00', activity: '松島海岸 & 美食', desc: '搭車前往日本三景之一的松島。吃在地小吃。\n\n【交通方式】\n1. 搭計程車回「岩沼駅」。\n2. 搭 JR東北本線 到「仙台站」。\n3. 轉乘 仙石線 到「松島海岸」。', customNavLink: 'https://maps.app.goo.gl/ULmj2QUzw8Rdvrnt9', subItems: [{ name: 'Pensee (パンセ)', desc: '松島限定的「生蚵咖哩麵包」，咬下去會爆漿，滿滿海味。', navButtons: [{ label: '導航', query: 'Pensee Matsushima' }, { label: '食記介紹', url: 'https://g8906011.pixnet.net/blog/post/577461672', icon: 'fa-solid fa-utensils' }] }, { name: '松島蒲鉾本舗', desc: '可以體驗親手烤魚板(笹かまぼこ)。剛烤好的魚板熱呼呼、口感Q彈。', navButtons: [{ label: '導航', query: 'Matsushima Kamaboko' }, { label: '食記介紹', url: 'https://kaleido0102.pixnet.net/blog/post/234021813', icon: 'fa-solid fa-utensils' }] }] },
                    { time: '13:00', activity: '松島遊船', desc: '【已預約 13:00】遊覽松島灣內星羅棋布的小島。船上有語音導覽介紹各個奇岩怪石。請務必於 12:45 前回到登船口。\n\n【行程彈性說明】\n若吃完小吃、買完船票後時間還充裕，建議先去旁邊的「五大堂」晃晃。\n若時間緊迫，則等下船後再去參觀。', customNavLink: 'https://maps.app.goo.gl/vAZmtW1M92yqMcqBA', links: [{ label: '遊船介紹', url: 'https://www.bring-you.info/zh-tw/matsushima-yuransen-pleasure-boats', icon: 'fa-solid fa-ship' }] },
                    { time: '', activity: '松島五大堂', desc: '松島的象徵，連結小島的「透橋」間隙很大，往下看得到海水，據說走過去可以試膽並消除厄運。', navButtons: [{ label: '導航', url: 'https://maps.app.goo.gl/AgB41A45f38L76eQ7' }, { label: '參觀介紹', url: 'https://look2uptravel.com/post-356134702/', icon: 'fa-solid fa-book-open' }] },
                    { time: '14:00', activity: '國寶參拜', desc: '參觀伊達家的菩提寺「瑞嚴寺」，並順路去買好吃的麵包。', subItems: [{ name: '瑞嚴寺', desc: '伊達家的菩提寺，本堂是國寶。內部金碧輝煌的屏風畫令人嘆為觀止。請注意時間，預計 15:30 離開。', navButtons: [{ label: '導航', url: 'https://maps.app.goo.gl/Hfjru6mqHN8uZDm39' }, { label: '參觀介紹', url: 'https://taitai.com.tw/japantravel-miyagitravel-matsushima-zuiganjitemple/', icon: 'fa-solid fa-book-open' }] }, { name: 'ぱんや あいざわ (Panya Aizawa)', desc: '在地人氣麵包店，推薦波羅麵包與牛角麵包，口感極佳。', navButtons: [{ label: '導航', url: 'https://maps.app.goo.gl/qf2EwjWfG1BGSEzY8' }, { label: '食記分享', url: 'https://hk.trip.com/moments/detail/matsushima-60862-131191559/', icon: 'fa-solid fa-utensils' }] }] },
                    { time: '15:50', activity: '松島復古館', desc: '需門票的小小博物館，展示昭和時期的各種小物、唱片、玩具等，充滿懷舊氛圍。預計 16:30 離開。', navButtons: [{ label: '導航', url: 'https://maps.app.goo.gl/6WC435DmPPZkwine6' }] },
                    { time: '16:30', activity: '福浦島 (紅橋)', desc: '雖然此時福浦島可能已打烊無法上島，但可以在知名的紅色「福浦橋」旁邊拍幾張照片，證明到此一遊！', navButtons: [{ label: '導航', url: 'https://maps.app.goo.gl/jBp5ZovvJcDiz3VF7' }, { label: '福浦島介紹', url: 'https://look2uptravel.com/post-356149618/', icon: 'fa-solid fa-book-open' }] },
                    { time: '18:00', activity: '仙台商店街', desc: '回到仙台市區的自由活動時間！\n這裡匯集了各種藥妝、電器與美食。\n\n【晚餐建議】\n想吃牛舌可以選「善治郎」，想吃拉麵有「一蘭」或其他名店。\n不想逛街的人，也可以直接回飯店整理戰利品，或去大澡堂泡個舒服的澡，洗去一天的疲憊。', customNavLink: 'https://maps.app.goo.gl/87eLRcGXYBUh3F7a8', navButtons: [{ label: '導航', url: 'https://maps.app.goo.gl/jrnnf6nnGANC12A98' }], subItems: [{ name: '仙台商店街', desc: '好逛好買的拱廊商店街。', navButtons: [{ label: '導航', url: 'https://maps.app.goo.gl/tiJwPxN4kkCxFxpH8' }, { label: '商店街介紹', url: 'https://nicklee.tw/2333/sendai-shopping-street/', icon: 'fa-solid fa-bag-shopping' }] }, { name: 'Dashiro (だし廊)', desc: '高評價拉麵店，湯頭鮮美，重點是有提供美味的「素食拉麵」！', navButtons: [{ label: '導航', url: 'https://maps.app.goo.gl/KpLywa9VaYp4TdLc8' }, { label: '食記分享', url: 'https://www.bigfang.tw/blog/post/dashiro-main-sendai', icon: 'fa-solid fa-utensils' }] }] }
                ]
            },
            {
                shortDate: '1/26', weekday: 'Day 7', title: '回程日', location: '仙台 → 桃園', stay: '溫暖的家',
                schedule: [
                    { time: '08:00', activity: '仙台朝市早餐', desc: '08:00 櫃台集合退房，並且寄放行李。\n被稱為「仙台的廚房」。距離仙台站走路只要5分鐘，雖然不大但充滿人情味。', links: [{ label: '朝市介紹', url: 'https://twobunny.tw/sendai-asaichi/', icon: 'fa-solid fa-utensils' }], subItemTitle: '朝市名店', subItems: [{ name: '伊藤商店', desc: '這裡有特色的「朝拉麵」(早餐吃拉麵)，清爽的醬油湯頭喚醒一天的活力。', query: 'Ito Shoten Sendai Asaichi' }, { name: '鮮魚店 浜伸', desc: '提供新鮮便宜的海鮮丼，滿滿的生魚片是離開前最後的享受。', query: 'Hamashin Sendai' }, { name: '阿美飯糰', desc: '手工現做的溫暖飯糰，口味選擇多，米飯非常好吃。', navButtons: [{ label: '導航', url: 'https://maps.app.goo.gl/vkEMVR7LiChgFLLFA' }] }, { name: '齋藤可樂餅', tag: '素食可', desc: '必吃的排隊名店。剛炸好的馬鈴薯可樂餅外酥內鬆軟，重點是有提供素食口味！', navButtons: [{ label: '導航', url: 'https://maps.app.goo.gl/vwRWo6TueNVpRXG29' }] }, { name: '花笠だんご本舗', desc: '販賣傳統日式糯米糰子與飯糰的小店，甜鹹口味都有，適合當作小點心。', navButtons: [{ label: '導航', url: 'https://maps.app.goo.gl/udo4kHLifxSGsKaS9' }] }] },
                    { time: '10:00', activity: '仙台大觀音', desc: '高達100公尺的巨大觀音像，矗立在住宅區中非常壯觀。可以買票進入觀音體內，登上頂層眺望風景。\n【最慢 11:30 前離開】', locationQuery: 'Sendai Daikannon', links: [{ label: '仙台大觀音介紹', url: 'https://www.maxfoodfun.com/blog/post/357563841', icon: 'fa-solid fa-book-open' }] },
                    { time: '12:00', activity: '午餐：嘉一拉麵', desc: '素食吃 Millis 以色列料理。被評為仙台第一名的拉麵店！特徵是純雞骨熬製的黃金湯頭，搭配手揉捲麵，口感Q彈。\n【素食吃 Millis 以色列料理】', tags: ['排隊名店'], subItemTitle: '午餐選擇', subItems: [{ name: '嘉一拉麵', desc: '只用雞骨熬煮的黃金湯頭，搭配富有嚼勁的手揉捲麵，是仙台拉麵界的王者。', navButtons: [{ label: '導航', url: 'https://maps.app.goo.gl/YmM7zU3P7FBRY38H8' }, { label: '拉麵食記', url: 'https://bow.foxpro.com.tw/blog.php?lid=2023%2F05%2F23_6MG18045C&sid=2016%2F07%2F20_4OQ04J5IG&pid=2016%2F07%2F23_4OT05QS6D', icon: 'fa-solid fa-utensils' }] }, { name: 'Millis -Shisha bar＆café', desc: '好吃的素食再吃一次！異國風味的 Falafel 與鷹嘴豆泥讓人回味無窮。', navButtons: [{ label: '導航', url: 'https://maps.app.goo.gl/wCm8A9FtpTVuBxo96' }] }] },
                    { time: '13:30', activity: '前往機場 & 伴手禮', desc: '吃飽喝足，回飯店拿行李，搭乘地鐵前往仙台機場。\n\n【伴手禮攻略】\n在 2F 出境大廳可以買到：\n1. **萩之月**：仙台銘菓，卡士達蛋糕。\n2. **喜久水庵**：喜久福大福 (毛豆/抹茶口味)。\n3. **毛豆泥麻糬 (Zunda)**。\n4. **牛舌真空包**：帶回台灣繼續回味。\n5. **阿部蒲鉾店**：炸葫蘆球(炸魚板)。\n\n推薦去「綜合免稅店 VEGA」或各品牌專櫃一次買齊！', locationQuery: 'Sendai Airport', links: [{ label: '伴手禮介紹', url: 'https://tiyama.net/sendai-airport-vega/', icon: 'fa-solid fa-gift' }] },
                    { time: '16:15', activity: '飛機起飛', desc: '搭乘長榮 BR117 回台灣 (預定台灣時間 19:30 抵達)。機上有提供飛機餐，請放心。抵達桃園機場後將由第二航廈入境。辛苦了，旅途愉快！', highlight: true }
                ]
            }
        ];

        // --- Methods ---
        const getTabName = (id) => {
            if (id === 'home') return '主頁面板';
            if (id === 'wallet') return '記帳分析';
            return '';
        };

        const openDetail = (item) => {
            selectedItem.value = item;
        };

        // Calculator Logic (Bidirectional)
        const updateTwd = () => {
             if (calcJpy.value === '') {
                calcTwd.value = '';
             } else {
                calcTwd.value = (parseFloat(calcJpy.value) * exchangeRate.value).toFixed(0);
             }
        };

        const updateJpy = () => {
            if (calcTwd.value === '') {
                calcJpy.value = '';
            } else {
                calcJpy.value = (parseFloat(calcTwd.value) / exchangeRate.value).toFixed(0);
            }
        };

        const getCatName = (id) => {
            const cat = categories.find(c => c.id === id);
            return cat ? cat.name : id;
        };

        const getCatIcon = (id) => {
             const cat = categories.find(c => c.id === id);
             return cat ? cat.icon : 'fa-solid fa-question';
        };

        const isFormValid = computed(() => {
            return newExpense.value.dateStr && newExpense.value.category && newExpense.value.item && newExpense.value.price;
        });

        const handleImageUpload = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const MAX_SIZE = 400;
                    let width = img.width;
                    let height = img.height;
                    if (width > height) {
                        if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; }
                    } else {
                        if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; }
                    }
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    newExpense.value.image = canvas.toDataURL('image/jpeg', 0.6);
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        };

        const addExpense = () => {
            if (!isFormValid.value) return;
            
            expenses.value.unshift({
                id: Date.now(),
                dateStr: newExpense.value.dateStr,
                category: newExpense.value.category,
                item: newExpense.value.item,
                price: parseFloat(newExpense.value.price),
                twd: parseFloat(newExpense.value.price) * exchangeRate.value,
                image: newExpense.value.image
            });
            
            saveData();
            newExpense.value.item = '';
            newExpense.value.price = '';
            newExpense.value.image = null;
        };

        const handleDelete = (id) => {
            if (confirmDeleteId.value === id) {
                const idx = expenses.value.findIndex(e => e.id === id);
                if (idx !== -1) {
                    expenses.value.splice(idx, 1);
                    saveData();
                }
                confirmDeleteId.value = null;
            } else {
                confirmDeleteId.value = id;
                setTimeout(() => { if (confirmDeleteId.value === id) confirmDeleteId.value = null; }, 3000);
            }
        };

        const toggleCheck = (index) => {
            checklist.value[index].checked = !checklist.value[index].checked;
            saveData();
        };

        const saveNotes = () => saveData();

        // Analysis Logic
        const filteredExpenses = computed(() => {
            if (!analysisFilter.value.start || !analysisFilter.value.end) return [];
            const start = new Date(analysisFilter.value.start).getTime();
            const end = new Date(analysisFilter.value.end).getTime();
            
            return expenses.value.filter(e => {
                const eDate = new Date(e.dateStr).getTime();
                return eDate >= start && eDate <= end && analysisFilter.value.categories.includes(e.category);
            });
        });

        const analysisTotal = computed(() => {
            return filteredExpenses.value.reduce((sum, e) => sum + e.price, 0);
        });

        const updateChart = () => {
            if (!showAnalysis.value) return;
            
            const ctx = document.getElementById('expenseChart');
            if (!ctx) return;

            // Group by category
            const dataMap = {};
            analysisFilter.value.categories.forEach(catId => dataMap[catId] = 0);
            
            filteredExpenses.value.forEach(e => {
                if (dataMap[e.category] !== undefined) {
                    dataMap[e.category] += e.price;
                }
            });

            const labels = categories.filter(c => analysisFilter.value.categories.includes(c.id)).map(c => c.name);
            const data = categories.filter(c => analysisFilter.value.categories.includes(c.id)).map(c => dataMap[c.id]);
            const bgColors = categories.filter(c => analysisFilter.value.categories.includes(c.id)).map(c => c.color);

            if (chartInstance) {
                chartInstance.destroy();
            }

            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: bgColors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        datalabels: {
                            color: '#fff',
                            font: { weight: 'bold' },
                            formatter: (value, ctx) => {
                                if (value === 0) return '';
                                return '¥' + value;
                            }
                        }
                    }
                }
            });
        };

        watch(showAnalysis, (val) => {
            if (val) nextTick(updateChart);
        });

        watch(analysisFilter, () => {
            if (showAnalysis.value) updateChart();
        }, { deep: true });


        const saveData = () => {
            const data = { expenses: expenses.value, checklist: checklist.value, notes: notes.value, exchangeRate: exchangeRate.value };
            localStorage.setItem('japanTrip2026_v5.3.1', JSON.stringify(data));
        };

        const loadData = () => {
            const data = localStorage.getItem('japanTrip2026_v5.3.1');
            if (data) {
                const parsed = JSON.parse(data);
                expenses.value = parsed.expenses || [];
                if(parsed.checklist) checklist.value = parsed.checklist;
                if(parsed.notes) notes.value = parsed.notes;
                if(parsed.exchangeRate) exchangeRate.value = parsed.exchangeRate;
            }
        };

        const detectedLinks = computed(() => {
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            return notes.value.match(urlRegex) || [];
        });

        // Weather Logic
        const weatherData = {
            0: { temp: 8, icon: 'fa-solid fa-plane', desc: '出發日・天氣不錯' }, // Day 0
            1: { temp: 6, icon: 'fa-solid fa-sun', desc: '東京・晴時多雲' }, // Day 1
            2: { temp: -2, icon: 'fa-regular fa-snowflake', desc: '銀山・大雪紛飛' }, // Day 2
            3: { temp: 1, icon: 'fa-solid fa-snowflake', desc: '山形・有雪有晴' }, // Day 3
            4: { temp: -5, icon: 'fa-solid fa-icicles', desc: '藏王・極寒樹冰' }, // Day 4
            5: { temp: 3, icon: 'fa-solid fa-cloud-sun', desc: '仙台・陰有雪' }, // Day 5
            6: { temp: 4, icon: 'fa-solid fa-wind', desc: '松島・海風強勁' }, // Day 6
            7: { temp: 5, icon: 'fa-solid fa-plane-departure', desc: '仙台・準備回程' } // Day 7
        };

        const getWeather = (day) => {
            return weatherData[day] || { temp: 0, icon: 'fa-solid fa-question', desc: '未知' };
        };

        // Japanese Navigation
        const openJpCategory = (cat) => {
            selectedCategory.value = cat;
            japaneseLevel.value = 2;
        };

        const openJpPhrase = (p) => {
            selectedPhrase.value = p;
            japaneseLevel.value = 3;
        };

        onMounted(() => loadData());

        return {
            currentTab, itinerary, activeDay, selectedItem,
            expenses, newExpense, checklist, notes, exchangeRate, 
            calcJpy, calcTwd,
            openDetail, handleImageUpload, addExpense, handleDelete, toggleCheck, saveNotes,
            updateTwd, updateJpy,
            dateOptions, categories, isFormValid, getCatName, getCatIcon, getTabName,
            showAnalysis, analysisFilter, analysisTotal, confirmDeleteId,
            showChecklistModal, japaneseLevel, japaneseData, selectedCategory, selectedPhrase,
            openJpCategory, openJpPhrase, getWeather
        };
    }
}).mount('#app');
</script>
</body>
</html>